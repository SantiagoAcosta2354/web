<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pokédex 3D Completa</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-red: #ff0000;
            --primary-yellow: #ffcc00;
            --secondary-blue: #3b4cca;
            --bg-light: #f5f5f5;
            --bg-dark: #121212;
            --text-light: #ffffff;
            --text-dark: #333333;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--bg-light);
            color: var(--text-dark);
            line-height: 1.6;
        }

        /* Header */
        header {
            background: linear-gradient(135deg, var(--primary-red), #cc0000);
            color: var(--text-light);
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            position: relative;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        h1 span {
            color: var(--primary-yellow);
        }

        /* Filtros */
        .filters {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.8rem;
            padding: 1.5rem;
            background: white;
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .filter-btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 2rem;
            background: #eee;
            color: #555;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .filter-btn.active {
            background: var(--secondary-blue);
            color: white;
        }

        /* Contenedor principal */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1.5rem;
        }

        /* Grid de modelos */
        .models-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 1.5rem;
            padding: 1rem 0;
        }

        /* Tarjetas de modelos */
        .model-card {
            background: white;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transition: all 0.3s;
            cursor: pointer;
            aspect-ratio: 1/1;
            position: relative;
        }

        .model-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        /* Miniaturas 3D */
        .thumbnail-container {
            width: 100%;
            height: 100%;
            position: relative;
            background: #f0f0f0;
        }

        .thumbnail-canvas {
            width: 100%;
            height: 100%;
        }

        .model-thumbnail {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .thumbnail-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: linear-gradient(135deg, #f5f5f5, #e0e0e0);
            color: #666;
            text-align: center;
            padding: 1rem;
        }

        .thumbnail-placeholder i {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            color: var(--secondary-blue);
        }

        .model-info {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 1rem;
            transform: translateY(100%);
            transition: transform 0.3s;
        }

        .model-card:hover .model-info {
            transform: translateY(0);
        }

        /* Paginación */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
            margin-top: 2rem;
            padding: 1rem;
        }

        .page-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            background: var(--secondary-blue);
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 100px;
        }

        .page-btn:hover {
            background: var(--primary-red);
        }

        .page-btn.active {
            background: var(--primary-yellow);
            color: var(--text-dark);
        }

        .page-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        #page-indicator {
            font-weight: bold;
            padding: 0 1rem;
        }

        /* Visor 3D */
        .viewer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .viewer-container {
            width: 90%;
            max-width: 900px;
            height: 85vh;
            background: var(--bg-dark);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
            display: grid;
            grid-template-rows: auto 1fr auto;
        }

        .viewer-header {
            padding: 1rem;
            background: #333;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }

        #model-canvas {
            width: 100%;
            height: 100%;
        }

        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 1.2rem;
            text-align: center;
        }

        .model-details {
            padding: 1rem;
            background: #222;
            color: white;
            max-height: 30vh;
            overflow-y: auto;
        }

        .detail-row {
            display: flex;
            margin-bottom: 0.5rem;
        }

        .detail-label {
            font-weight: bold;
            color: var(--primary-yellow);
            min-width: 120px;
        }

        /* Controles de calidad */
        .quality-controls {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem;
            justify-content: center;
            background: #333;
        }

        .quality-btn {
            padding: 0.3rem 0.6rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: #555;
            color: white;
        }

        .quality-btn.active {
            background: var(--primary-red);
            color: white;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .models-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            }
            
            .viewer-container {
                width: 95%;
                height: 90vh;
            }
        }

        @media (max-width: 480px) {
            .models-grid {
                grid-template-columns: 1fr 1fr;
                gap: 1rem;
            }
            
            .filters {
                padding: 1rem 0.5rem;
                gap: 0.5rem;
            }
            
            .filter-btn {
                padding: 0.5rem 0.8rem;
                font-size: 0.9rem;
            }
            
            .page-btn {
                min-width: auto;
                padding: 6px 12px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>Pokédex <span>3D</span></h1>
        <p>Explora todos los modelos Pokémon en alta calidad</p>
    </header>
    
    <div class="filters">
        <button class="filter-btn active" data-category="all">Todos</button>
        <button class="filter-btn" data-category="pokemon">Pokémon</button>
        <button class="filter-btn" data-category="elemento">Elementos</button>
        <button class="filter-btn" data-category="carta">Cartas</button>
    </div>
    
    <div class="main-container">
        <div class="models-grid" id="models-container">
            <!-- Las tarjetas se generan dinámicamente con JS -->
        </div>

        <!-- Paginación -->
        <div class="pagination">
            <button id="prev-page" class="page-btn" disabled>
                <i class="fas fa-chevron-left"></i> Anterior
            </button>
            <div id="page-indicator">Página 1 de 5</div>
            <button id="next-page" class="page-btn">
                Siguiente <i class="fas fa-chevron-right"></i>
            </button>
        </div>
    </div>
    
    <!-- Visor 3D -->
    <div class="viewer-overlay" id="model-viewer">
        <div class="viewer-container">
            <div class="viewer-header">
                <h2 id="viewer-title">Cargando modelo...</h2>
                <button class="close-btn" id="close-viewer">&times;</button>
            </div>
            
            <div id="model-canvas"></div>
            <div class="loading-spinner" id="loading-spinner">
                <i class="fas fa-spinner fa-spin fa-2x"></i><br>
                <span id="loading-text">Cargando modelo 3D...</span>
            </div>
            
            <div class="quality-controls">
                <button class="quality-btn active" data-quality="low">Bajo Rendimiento</button>
                <button class="quality-btn" data-quality="medium">Equilibrado</button>
                <button class="quality-btn" data-quality="high">Alta Calidad</button>
            </div>
            
            <div class="model-details" id="model-details">
                <div class="detail-row">
                    <span class="detail-label">Nombre:</span>
                    <span id="detail-name">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Tipo:</span>
                    <span id="detail-type">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Categoría:</span>
                    <span id="detail-category">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Generación:</span>
                    <span id="detail-gen">-</span>
                </div>
                <div class="detail-row">
                    <span class="detail-label">Descripción:</span>
                    <span id="detail-desc">-</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Three.js desde CDN -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/examples/js/loaders/GLTFLoader.js"></script>

    <!-- Script principal -->
    <script>
        // Configuración
        const THUMBNAIL_QUALITY = 'low'; // 'low', 'medium', 'high'
        const THUMBNAIL_SIZE = 128;
        const MODELS_PER_PAGE = 6;

        // Datos de los modelos (30 modelos)
        const modelos = [
            { 
                id: 1,
                file: "models/gameboy.glb", 
                category: "elemento", 
                name: "Game Boy",
                type: "Consola",
                generation: "Clásica",
                description: "La consola portátil donde comenzó todo. Lanzada en 1989."
            },
            { 
                id: 2,
                file: "models/geodude.glb", 
                category: "pokemon", 
                name: "Geodude",
                type: "Roca/Tierra",
                generation: "Kanto (1)",
                description: "Pokémon roca que se encuentra en cuevas y montañas."
            },
            { 
                id: 3,
                file: "models/mew.glb", 
                category: "pokemon", 
                name: "Mew",
                type: "Psíquico",
                generation: "Kanto (1)",
                description: "Pokémon legendario que contiene el ADN de todos los Pokémon."
            },
            { 
                id: 4,
                file: "models/espeon.glb", 
                category: "pokemon", 
                name: "Espeon",
                type: "Psíquico",
                generation: "Johto (2)",
                description: "Evolución de Eevee. Puede predecir el futuro con su cola bifurcada."
            },
            { 
                id: 5,
                file: "models/flareon.glb", 
                category: "pokemon", 
                name: "Flareon",
                type: "Fuego",
                generation: "Kanto (1)",
                description: "Evolución de Eevee. Su cuerpo alcanza temperaturas de 900°C."
            },
            { 
                id: 6,
                file: "models/glaceon.glb", 
                category: "pokemon", 
                name: "Glaceon",
                type: "Hielo",
                generation: "Sinnoh (4)",
                description: "Evolución de Eevee. Puede congelar la humedad del aire."
            },
            { 
                id: 7,
                file: "models/jolteon.glb", 
                category: "pokemon", 
                name: "Jolteon",
                type: "Eléctrico",
                generation: "Kanto (1)",
                description: "Evolución de Eevee. Genera 10,000 voltios de electricidad."
            },
            { 
                id: 8,
                file: "models/leafeon.glb", 
                category: "pokemon", 
                name: "Leafeon",
                type: "Planta",
                generation: "Sinnoh (4)",
                description: "Evolución de Eevee. Realiza fotosíntesis con sus células."
            },
            { 
                id: 9,
                file: "models/vaporeon.glb", 
                category: "pokemon", 
                name: "Vaporeon",
                type: "Agua",
                generation: "Kanto (1)",
                description: "Evolución de Eevee. Su estructura molecular es similar al agua."
            },
            { 
                id: 10,
                file: "models/charmander.glb", 
                category: "pokemon", 
                name: "Charmander",
                type: "Fuego",
                generation: "Kanto (1)",
                description: "Pokémon lagarto. La llama en su cola indica su salud."
            },
            { 
                id: 11,
                file: "models/pokeball.glb", 
                category: "elemento", 
                name: "Poké Ball",
                type: "Dispositivo",
                generation: "Clásica",
                description: "Dispositivo para capturar Pokémon. Tecnología de miniaturización."
            },
            
            { 
                id: 13,
                file: "models/miniq.glb", 
                category: "pokemon", 
                name: "Miniqu",
                type: "Volador",
                generation: "Nueva (7+)",
                description: "Pokémon pequeño con gran agilidad aérea."
            },
            { 
                id: 14,
                file: "models/pokemart.glb", 
                category: "elemento", 
                name: "Poké Mart",
                type: "Tienda",
                generation: "Clásica",
                description: "Tienda donde los entrenadores compran suministros."
            },
            { 
                id: 15,
                file: "models/pokemon_center.glb", 
                category: "elemento", 
                name: "Centro Pokémon",
                type: "Edificio",
                generation: "Clásica",
                description: "Hospital para Pokémon con enfermeras Joy."
            },
            { 
                id: 16,
                file: "models/tree.glb", 
                category: "pokemon", 
                name: "Tree",
                type: "Planta",
                generation: "Nueva (7+)",
                description: "Pokémon arbóreo que protege los bosques."
            },
            { 
                id: 18,
                file: "models/whimsicott.glb", 
                category: "pokemon", 
                name: "Whimsicott",
                type: "Planta/Hada",
                generation: "Teselia (5)",
                description: "Pokémon algodón que flota con el viento."
            },
            { 
                id: 20,
                file: "models/gyarados.glb", 
                category: "carta", 
                name: "Carta Gyarados",
                type: "Agua",
                generation: "Clásica",
                description: "Carta coleccionable del temible Gyarados."
            },
            { 
                id: 21,
                file: "models/kanto_badges__box.glb", 
                category: "elemento", 
                name: "Caja de Insignias",
                type: "Colección",
                generation: "Kanto (1)",
                description: "Contiene las 8 insignias de los gimnasios de Kanto."
            },
            { 
                id: 22,
                file: "models/legendary_pokemon_reshiram.glb", 
                category: "pokemon", 
                name: "Reshiram",
                type: "Dragón/Fuego",
                generation: "Teselia (5)",
                description: "Pokémon legendario que representa la verdad."
            },
            { 
                id: 23,
                file: "models/center_diorama.glb", 
                category: "elemento", 
                name: "Diorama Centro",
                type: "Escenario",
                generation: "Clásica",
                description: "Maqueta de un Centro Pokémon con detalles interactivos."
            },
            { 
                id: 24,
                file: "models/pikachu.glb", 
                category: "carta", 
                name: "Carta Pikachu",
                type: "Eléctrico",
                generation: "Clásica",
                description: "Carta coleccionable del Pokémon más famoso."
            },
            { 
                id: 25,
                file: "models/firered_players_room.glb", 
                category: "elemento", 
                name: "Habitación FireRed",
                type: "Escenario",
                generation: "Kanto (1)",
                description: "Réplica de la habitación inicial en Pokémon FireRed."
            },
            { 
                id: 26,
                file: "models/loreleis_arena.glb", 
                category: "elemento", 
                name: "Arena Lorelei",
                type: "Escenario",
                generation: "Kanto (1)",
                description: "Campo de batalla de la Élite Four en las Islas Remolino."
            },
            { 
                id: 27,
                file: "models/pokedex.glb", 
                category: "elemento", 
                name: "Pokédex",
                type: "Dispositivo",
                generation: "Clásica",
                description: "Enciclopedia electrónica que registra datos Pokémon."
            },
            { 
                id: 28,
                file: "models/professor_oak.glb", 
                category: "elemento", 
                name: "Profesor Oak",
                type: "Personaje",
                generation: "Kanto (1)",
                description: "El famoso profesor que inicia a los entrenadores."
            },
            { 
                id: 29,
                file: "models/charizard.glb", 
                category: "carta", 
                name: "Carta Charizard",
                type: "Fuego",
                generation: "Clásica",
                description: "Una de las cartas más valiosas del TCG."
            },
            
        ];

        // Variables globales
        let currentPage = 1;
        let filteredModels = [...modelos];
        let thumbnails = {};
        let mainScene, mainCamera, mainRenderer, mainControls, currentModel = null;
        let quality = 'medium';

        // Inicialización
        document.addEventListener('DOMContentLoaded', async () => {
            await initThumbnails();
            renderModels();
            setupEventListeners();
        });

        // 1. Inicializar miniaturas 3D
        async function initThumbnails() {
            const loadingPromises = modelos.map(model => 
                generateThumbnail(model.file).then(thumbnail => {
                    thumbnails[model.id] = thumbnail;
                }).catch(error => {
                    console.error(`Error generando miniatura para ${model.name}:`, error);
                    thumbnails[model.id] = null;
                })
            );
            
            await Promise.all(loadingPromises);
        }

        // 2. Generar miniatura 3D
        function generateThumbnail(modelPath) {
            return new Promise((resolve, reject) => {
                try {
                    const scene = new THREE.Scene();
                    scene.background = new THREE.Color(0xf0f0f0);
                    
                    const camera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
                    camera.position.z = 2;
                    
                    const renderer = new THREE.WebGLRenderer({ 
                        antialias: true,
                        alpha: THUMBNAIL_QUALITY !== 'low',
                        powerPreference: THUMBNAIL_QUALITY === 'low' ? 'low-power' : 'high-performance'
                    });
                    renderer.setSize(THUMBNAIL_SIZE, THUMBNAIL_SIZE);
                    
                    // Iluminación
                    const ambientLight = new THREE.AmbientLight(0xffffff, 1.5);
                    scene.add(ambientLight);
                    
                    const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
                    directionalLight.position.set(1, 1, 1);
                    scene.add(directionalLight);
                    
                    // Cargar modelo
                    const loader = new THREE.GLTFLoader();
                    loader.load(modelPath, (gltf) => {
                        const model = gltf.scene;
                        
                        // Ajustar modelo
                        const box = new THREE.Box3().setFromObject(model);
                        const size = box.getSize(new THREE.Vector3()).length();
                        const center = box.getCenter(new THREE.Vector3());
                        
                        model.position.x = -center.x;
                        model.position.y = -center.y;
                        model.position.z = -center.z;
                        
                        const scale = 1.5 / size;
                        model.scale.set(scale, scale, scale);
                        
                        // Rotación inicial para mejor visualización
                        model.rotation.y = Math.PI / 4;
                        
                        scene.add(model);
                        
                        // Renderizar
                        renderer.render(scene, camera);
                        const thumbnail = renderer.domElement.toDataURL('image/png');
                        
                        // Limpiar
                        scene.remove(model);
                        renderer.dispose();
                        
                        resolve(thumbnail);
                    }, undefined, (error) => {
                        renderer.dispose();
                        reject(error);
                    });
                } catch (error) {
                    reject(error);
                }
            });
        }

        // 3. Renderizar modelos en la cuadrícula
        function renderModels() {
            const startIdx = (currentPage - 1) * MODELS_PER_PAGE;
            const endIdx = startIdx + MODELS_PER_PAGE;
            const modelsToShow = filteredModels.slice(startIdx, endIdx);
            
            const container = document.getElementById('models-container');
            container.innerHTML = '';
            
            modelsToShow.forEach(model => {
                const card = document.createElement('div');
                card.className = 'model-card';
                card.dataset.id = model.id;
                
                // Verificar si la miniatura está disponible
                const hasThumbnail = thumbnails[model.id] !== undefined && thumbnails[model.id] !== null;
                
                card.innerHTML = `
                    <div class="thumbnail-container">
                        ${hasThumbnail ? 
                            `<img src="${thumbnails[model.id]}" class="model-thumbnail" alt="${model.name}">` : 
                            `<div class="thumbnail-placeholder">
                                <i class="fas fa-cube"></i>
                                <span>${model.name}</span>
                                <small>${thumbnails[model.id] === undefined ? 'Cargando...' : 'Miniatura no disponible'}</small>
                            </div>`
                        }
                    </div>
                    <div class="model-info">
                        <h3>${model.name}</h3>
                        <p>${model.type}</p>
                    </div>
                `;
                
                // Si no hay miniatura y no se ha intentado cargar antes, intentar generarla
                if (!hasThumbnail && thumbnails[model.id] === undefined) {
                    generateThumbnail(model.file)
                        .then(thumbnail => {
                            thumbnails[model.id] = thumbnail;
                            updateModelThumbnail(model.id, thumbnail);
                        })
                        .catch(() => {
                            thumbnails[model.id] = null;
                            updateModelThumbnail(model.id, null);
                        });
                }
                
                card.addEventListener('click', () => showModelViewer(model));
                container.appendChild(card);
            });
            
            updatePagination();
        }

        // 4. Actualizar miniatura de un modelo
        function updateModelThumbnail(modelId, thumbnail) {
            const card = document.querySelector(`.model-card[data-id="${modelId}"]`);
            if (!card) return;
            
            const container = card.querySelector('.thumbnail-container');
            if (!container) return;
            
            if (thumbnail) {
                container.innerHTML = `<img src="${thumbnail}" class="model-thumbnail" alt="${modelos.find(m => m.id === modelId).name}">`;
            } else {
                const model = modelos.find(m => m.id === modelId);
                container.innerHTML = `
                    <div class="thumbnail-placeholder">
                        <i class="fas fa-cube"></i>
                        <span>${model.name}</span>
                        <small>Miniatura no disponible</small>
                    </div>
                `;
            }
        }

        // 5. Actualizar paginación
        function updatePagination() {
            const totalPages = Math.ceil(filteredModels.length / MODELS_PER_PAGE);
            document.getElementById('page-indicator').textContent = `Página ${currentPage} de ${totalPages}`;
            document.getElementById('prev-page').disabled = currentPage === 1;
            document.getElementById('next-page').disabled = currentPage === totalPages || totalPages === 0;
        }

        // 6. Filtrar modelos por categoría
        function filterModels(category) {
            filteredModels = category === 'all' 
                ? [...modelos] 
                : modelos.filter(model => model.category === category);
            
            currentPage = 1;
            renderModels();
        }

        // 7. Mostrar visor 3D completo
        async function showModelViewer(model) {
            const viewer = document.getElementById('model-viewer');
            const title = document.getElementById('viewer-title');
            const spinner = document.getElementById('loading-spinner');
            
            // Mostrar información básica
            title.textContent = model.name;
            document.getElementById('detail-name').textContent = model.name;
            document.getElementById('detail-type').textContent = model.type;
            document.getElementById('detail-category').textContent = model.category.charAt(0).toUpperCase() + model.category.slice(1);
            document.getElementById('detail-gen').textContent = model.generation;
            document.getElementById('detail-desc').textContent = model.description;
            
            // Mostrar visor
            viewer.style.display = 'flex';
            spinner.style.display = 'flex';
            document.getElementById('loading-text').textContent = `Cargando ${model.name}...`;
            
            // Inicializar Three.js si no está inicializado
            if (!mainRenderer) {
                await initMainViewer();
            } else {
                // Limpiar escena si hay un modelo previo
                if (currentModel) {
                    mainScene.remove(currentModel);
                    disposeModel(currentModel);
                }
            }
            
            // Cargar el modelo 3D
            loadMainModel(model.file);
        }

        // 8. Inicializar el visor principal
        function initMainViewer() {
            return new Promise((resolve) => {
                // Escena
                mainScene = new THREE.Scene();
                mainScene.background = new THREE.Color(0x121212);
                
                // Cámara
                const canvas = document.getElementById('model-canvas');
                mainCamera = new THREE.PerspectiveCamera(75, canvas.clientWidth / canvas.clientHeight, 0.1, 1000);
                mainCamera.position.z = 3;
                
                // Renderizador
                mainRenderer = new THREE.WebGLRenderer({ 
                    antialias: true,
                    powerPreference: quality === 'low' ? 'low-power' : 'high-performance'
                });
                mainRenderer.setSize(canvas.clientWidth, canvas.clientHeight);
                canvas.appendChild(mainRenderer.domElement);
                
                // Controles
                mainControls = new THREE.OrbitControls(mainCamera, mainRenderer.domElement);
                mainControls.enableDamping = true;
                mainControls.dampingFactor = 0.05;
                mainControls.screenSpacePanning = false;
                mainControls.maxPolarAngle = Math.PI;
                mainControls.minDistance = 1;
                mainControls.maxDistance = 10;
                
                // Iluminación
                const ambientLight = new THREE.AmbientLight(0x404040, quality === 'low' ? 1.2 : 1.5);
                mainScene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, quality === 'low' ? 0.8 : 1);
                directionalLight.position.set(5, 5, 5);
                directionalLight.castShadow = quality !== 'low';
                mainScene.add(directionalLight);
                
                // Animación
                animateMainViewer();
                resolve();
            });
        }

        // 9. Cargar modelo principal
        function loadMainModel(modelPath) {
            const loader = new THREE.GLTFLoader();
            const spinner = document.getElementById('loading-spinner');
            
            loader.load(
                modelPath,
                (gltf) => {
                    currentModel = gltf.scene;
                    
                    // Configurar sombras según calidad
                    currentModel.traverse(child => {
                        if (child.isMesh) {
                            child.castShadow = quality !== 'low';
                            child.receiveShadow = quality !== 'low';
                            
                            // Optimizar materiales
                            if (quality === 'low') {
                                if (child.material.map) child.material.map.anisotropy = 0;
                                child.material.needsUpdate = true;
                            }
                        }
                    });
                    
                    // Centrar modelo
                    const box = new THREE.Box3().setFromObject(currentModel);
                    const center = box.getCenter(new THREE.Vector3());
                    currentModel.position.x = -center.x;
                    currentModel.position.y = -center.y;
                    currentModel.position.z = -center.z;
                    
                    // Escalar según tamaño
                    const size = box.getSize(new THREE.Vector3()).length();
                    let scale = 2 / size;
                    
                    // Ajustes especiales para modelos grandes
                    if (modelPath.includes('center') || modelPath.includes('arena') || modelPath.includes('room')) {
                        scale = 1 / size;
                    }
                    
                    currentModel.scale.set(scale, scale, scale);
                    
                    mainScene.add(currentModel);
                    spinner.style.display = 'none';
                },
                (xhr) => {
                    // Mostrar progreso
                    const percent = (xhr.loaded / xhr.total) * 100;
                    document.getElementById('loading-text').textContent = `Cargando... ${Math.round(percent)}%`;
                },
                (error) => {
                    console.error('Error loading model:', error);
                    document.getElementById('loading-text').innerHTML = 
                        `<i class="fas fa-exclamation-triangle"></i> Error al cargar el modelo<br>
                         <small>${error.message || 'Intenta recargar la página'}</small>`;
                }
            );
        }

        // 10. Animación del visor principal
        function animateMainViewer() {
            requestAnimationFrame(animateMainViewer);
            if (mainControls) mainControls.update();
            if (mainRenderer && mainScene && mainCamera) {
                mainRenderer.render(mainScene, mainCamera);
            }
        }

        // 11. Aplicar ajustes de calidad
        function applyQualitySettings(level) {
            quality = level;
            
            if (!mainRenderer) return;
            
            switch(level) {
                case 'high':
                    mainRenderer.setPixelRatio(window.devicePixelRatio);
                    if (currentModel) {
                        currentModel.traverse(child => {
                            if (child.isMesh) {
                                child.castShadow = true;
                                child.receiveShadow = true;
                                if (child.material.map) child.material.map.anisotropy = mainRenderer.capabilities.getMaxAnisotropy();
                            }
                        });
                    }
                    break;
                    
                case 'medium':
                    mainRenderer.setPixelRatio(1);
                    if (currentModel) {
                        currentModel.traverse(child => {
                            if (child.isMesh) {
                                child.castShadow = true;
                                child.receiveShadow = true;
                                if (child.material.map) child.material.map.anisotropy = 2;
                            }
                        });
                    }
                    break;
                    
                case 'low':
                    mainRenderer.setPixelRatio(1);
                    if (currentModel) {
                        currentModel.traverse(child => {
                            if (child.isMesh) {
                                child.castShadow = false;
                                child.receiveShadow = false;
                                if (child.material.map) child.material.map.anisotropy = 0;
                            }
                        });
                    }
                    break;
            }
            
            // Reajustar iluminación
            mainScene.traverse(obj => {
                if (obj.isLight) {
                    if (obj.isAmbientLight) {
                        obj.intensity = level === 'low' ? 1.2 : 1.5;
                    } else {
                        obj.intensity = level === 'low' ? 0.8 : 1;
                        obj.castShadow = level !== 'low';
                    }
                }
            });
        }

        // 12. Liberar recursos del modelo
        function disposeModel(model) {
            model.traverse(child => {
                if (child.isMesh) {
                    child.geometry.dispose();
                    if (child.material) {
                        if (child.material.map) child.material.map.dispose();
                        if (child.material.normalMap) child.material.normalMap.dispose();
                        child.material.dispose();
                    }
                }
            });
        }

        // 13. Configurar event listeners
        function setupEventListeners() {
            // Filtros
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    
                    const category = btn.dataset.category;
                    filterModels(category);
                });
            });
            
            // Paginación
            document.getElementById('prev-page').addEventListener('click', () => {
                if (currentPage > 1) {
                    currentPage--;
                    renderModels();
                }
            });
            
            document.getElementById('next-page').addEventListener('click', () => {
                const totalPages = Math.ceil(filteredModels.length / MODELS_PER_PAGE);
                if (currentPage < totalPages) {
                    currentPage++;
                    renderModels();
                }
            });
            
            // Cerrar visor
            document.getElementById('close-viewer').addEventListener('click', () => {
                document.getElementById('model-viewer').style.display = 'none';
            });
            
            // Controles de calidad
            document.querySelectorAll('.quality-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.quality-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    applyQualitySettings(btn.dataset.quality);
                });
            });
            
            // Redimensionamiento
            window.addEventListener('resize', () => {
                if (mainRenderer && mainCamera) {
                    const canvas = document.getElementById('model-canvas');
                    mainCamera.aspect = canvas.clientWidth / canvas.clientHeight;
                    mainCamera.updateProjectionMatrix();
                    mainRenderer.setSize(canvas.clientWidth, canvas.clientHeight);
                }
            });
        }
    </script>
</body>
</html>